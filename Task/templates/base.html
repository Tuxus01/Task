{% load static %}
<!DOCTYPE html>
<html>

<head>

  <!--############################### TE GUSTA LEER EL CODIGO AJENO ? #####################################-->
  <!--############################### SUERTE ENTENDIENDO LO QUE HICE :(  #####################################-->


  <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.11.1/jquery.min.js"></script>

  <!-- Fotorama from CDNJS, 19 KB -->
  <link href="https://cdnjs.cloudflare.com/ajax/libs/fotorama/4.6.4/fotorama.css" rel="stylesheet">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/fotorama/4.6.4/fotorama.js"></script>


  <link href="https://fonts.googleapis.com/css?family=Roboto:100,300,400,500,700,900" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/@mdi/font@5.x/css/materialdesignicons.min.css" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/vuetify@2.x/dist/vuetify.min.css" rel="stylesheet">
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no, minimal-ui">
  <link href="https://unpkg.com/material-components-web@latest/dist/material-components-web.min.css" rel="stylesheet">
  <script src="https://unpkg.com/material-components-web@latest/dist/material-components-web.min.js"></script>
  <link rel="stylesheet" href="https://fonts.googleapis.com/icon?family=Material+Icons">

</head>

<body>
  <div id="app">
    <template>
      <v-app id="inspire">
        <form action="#" method="get">
          <v-app-bar :clipped-left="$vuetify.breakpoint.lgAndUp" app dark dense>
            <v-app-bar-nav-icon @click.stop="drawer2 = !drawer2"></v-app-bar-nav-icon>
            <v-toolbar-title style="width: 300px" class="ml-0 pl-4">
              <span >Task Manager </span>
            </v-toolbar-title>


            <v-spacer></v-spacer>

            {% if user.is_authenticated %}
            <v-btn @click="dialogProyecto=true" small fab color="green">
              <v-icon>mdi-plus</v-icon>
            </v-btn>
            <v-divider inset class="mx-4" vertical></v-divider>



            {{ user.first_name }} {{ user.last_name}}</br>

            {% else %}
            <v-btn href="" icon>
              <v-icon>mdi-facebook</v-icon>
              </v-badge>
            </v-btn>

            {% endif %}


          </v-app-bar>


        </form>



        <v-main>

          {% block content %}

          {%  endblock %}

        </v-main>
      </v-app>
    </template>


  </div>







  <!--Informacion del contenido a mostrar -->


  <script src="https://unpkg.com/axios/dist/axios.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/vue@2.x/dist/vue.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/vuetify@2.x/dist/vuetify.js"></script>


  {% block script %}

  {% endblock %}



  <script>


    var CSRF_TOKEN = '{{ csrf_token }}'
    var ID_Token = {{ user.id }}

    console.log(csrf_token)
  </script>



  <script>

    var app = new Vue({

      delimiters: ['[[', ']]'],
      el: '#app',

      vuetify: new Vuetify(),
      data: {
        dialog: false,
        drawer: false,
        drawer2: false,
        drawerEdit: false,

        //ID temporal del task que servira para poder realizar la insercion de comentarios desde
        //el drawer izquierdo de la aplicacion
        id_task: 0,
        id_task_comentario: '',
        id_Project_Task: 0,

        //Menu Derecho con lista de Projectos agregados como miembro.
        Project_list: [],


        //List Desplegado Kamban Table
        itemsKamban: [],
        subitemKamban: [],

        //Navegacion entre opciones, Lista, Dashboard, Table, Kamban, TimeLine, Image
        bottomNav: 3,
        bottomNavProject: '',

        //Barra Izquierda 
        //Listado de Comentarios
        List_Task_drawer: [],
        List_Comment_drawer: [],
        //Adjunto de archivos varios


        //Diaglo para agregar y modificar Proyecto
        dialogProyecto: false,
        //Diaglogo para agregar Kamban a Proyecto
        dialogKamban: false,
        //Diaglo para agregar task a kamban del proyecto
        dialogKambanTask: false,
        files: [],

        //NOTIFICACIONES PUSH
        snackbar: false,
        snackbar_titulo: '',
        snackbar_comentario: '',

        //Urgencia Select creacion de proyecto
        Nivel_urgencia: [
          { 'id': 1, 'nombre': 'Low' },
          { 'id': 2, 'nombre': 'Medium' },
          { 'id': 3, 'nombre': 'Urgent' },
          { 'id': 4, 'nombre': 'Wait' },
        ],
        Nivel_urgencia_select: '',

        //Card de creacion de task
        show: true,

        desserts: [
          {
            name: 'Task1',
            calories: 159,
          },
          {
            name: 'Task2',
            calories: 237,
          },
          {
            name: 'Task3',
            calories: 262,
          },

        ],


        //Variables para agregar proyecto desde fomulario Dialogo
        project_name_add: '',
        project_description_add: '',
        //Projecto Lista de Tabla 
        singleSelectProjectCreate: false,
        selectedProjectCreate: [],
        kambaProjectCreate : [],
        headersProjectCreate: [
          {
            text: 'Project Name',
            align: 'start',
            sortable: false,
            value: 'name',
          },

          { text: 'Description', value: 'description' },

        ],
        dessertsProjectCreate: [
          {
            name: 'Frozen Yogurt',
            calories: 159,
            fat: 6.0,
            carbs: 24,
            protein: 4.0,
            iron: '1%',
          },
          {
            name: 'Ice cream sandwich',
            calories: 237,
            fat: 9.0,
            carbs: 37,
            protein: 4.3,
            iron: '1%',
          },
          {
            name: 'Eclair',
            calories: 262,
            fat: 16.0,
            carbs: 23,
            protein: 6.0,
            iron: '7%',
          },

        ],


          ///CALENDAR PRUEBASSSSSSSS
          focus: '',
          type: 'month',
          typeToLabel: {
            month: 'Month',
            week: 'Week',
            day: 'Day',
            '4day': '4 Days',
          },
          selectedEvent: {},
          selectedElement: null,
          selectedOpen: false,
          events: [],
          colors: ['blue', 'indigo', 'deep-purple', 'cyan', 'green', 'orange', 'grey darken-1'],
          names: ['Meeting', 'Holiday', 'PTO', 'Travel', 'Event', 'Birthday', 'Conference', 'Party'],

          ///CALENDAR PRUEBASSSSSSSS

      },
      watch: {
      },

      computed: {
        getProjectID: function () {
          var id = 0
          if (this.selectedProjectCreate) {
            id = this.selectedProjectCreate
            this.List_Kamban_Task_Project_Select(id)
            return this.selectedProjectCreate
          }
        }


      },
      mounted() {
        ///Calendarios
        this.$refs.calendar.checkChange()

        //Mostrar listado de proyecto automaticamente 
        this.ListProject()
      },

      methods: {

        ///CALENDAR PRUEBASSSSSSSSSSSSSSSSSSSSSSS

        viewDay ({ date }) {
        this.focus = date
        this.type = 'day'
      },
      getEventColor (event) {
        return event.color
      },
      setToday() {
        this.focus = ''
      },
      prev () {
        this.$refs.calendar.prev()
      },
      next () {
        this.$refs.calendar.next()
      },
      showEvent ({ nativeEvent, event }) {
        const open = () => {
          this.selectedEvent = event
          this.selectedElement = nativeEvent.target
          setTimeout(() => this.selectedOpen = true, 10)
        }

        if (this.selectedOpen) {
          this.selectedOpen = false
          setTimeout(open, 10)
        } else {
          open()
        }

        nativeEvent.stopPropagation()
      },
      updateRange ({ start, end }) {
        const events = []

        const min = new Date(`${start.date}T00:00:00`)
        const max = new Date(`${end.date}T23:59:59`)
        const days = (max.getTime() - min.getTime()) / 86400000
        const eventCount = this.rnd(days, days + 20)

        for (let i = 0; i < eventCount; i++) {
          const allDay = this.rnd(0, 3) === 0
          const firstTimestamp = this.rnd(min.getTime(), max.getTime())
          const first = new Date(firstTimestamp - (firstTimestamp % 900000))
          const secondTimestamp = this.rnd(2, allDay ? 288 : 8) * 900000
          const second = new Date(first.getTime() + secondTimestamp)

          events.push({
            name: this.names[this.rnd(0, this.names.length - 1)],
            start: first,
            end: second,
            color: this.colors[this.rnd(0, this.colors.length - 1)],
            timed: !allDay,
          })
        }

        this.events = events
      },
      rnd (a, b) {
        return Math.floor((b - a + 1) * Math.random()) + a
      },


      ///CALENDAR PRUEBASSSSSSSSSSSSSSSSSSSSSSSSS

        alert(dato){
          console.log('Click')
        },

        List_subTask2() {
          console.log("DOBLE CLICK")
        },
        //Listar projecto a los cuales pertenezco 

        //Funcion para agregar nuevos proyectos a db
        ListProjectAdd() {
          var self = this;
          //console.log(self.id_task)

          axios.post('/api/v1.0/project/', {
            name: self.project_name_add,
            owner: ID_Token,
            description: self.project_description_add,
          }, {
            headers: { 'X-CSRFTOKEN': CSRF_TOKEN, },
          })
            .then(function (response) {
              //console.log(response);
              self.project_name_add = ""
              self.project_description_add = ""
              self.notification('New Project', 'Action added successfully')
              self.Members_add(response.data.id, ID_Token)


            })
            .catch(function (error) {
              console.log(error);
            });

        },

        Members_add(project_id, user_id) {
          var self = this;
          //console.log(self.id_task)

          axios.post('/api/v1.0/members/', {
            project: project_id,
            owner: ID_Token,
            member: user_id,
          }, {
            headers: { 'X-CSRFTOKEN': CSRF_TOKEN, },
          })
            .then(function (response) {
              //console.log(response);
              self.ListProject()

            })
            .catch(function (error) {
              console.log(error);
            });

        },

        ListProject() {
          var self = this;
          axios.get('/api/v1.0/project/')
            .then(response => {
              this.Project_list = response.data
              this.dessertsProjectCreate = response.data
            })
            .catch(error => { console.log(error) })
        },
        //Funcion para apartado de tabla
        //Funcion creada para llamar las tareas de las tablas por medio del id del project
        //Esto es muy importante para cargar solo la informacion de lo que se quiere trabajar.
        List_Table(id) {
          //console.log(id)
          var self = this;
          axios.get('/api/v1.0/project/' + id + '/')
            .then(response => {
              //this.Project_list = response.data
              //console.log(response.data)
              self.itemsKamban = response.data
            })
            .catch(error => { console.log(error) })
        },
        //Enlistar las tareas principales de los kamban de projecto en curso o ejecucion
        List_subTask(id) {
          var self = this;
          //console.log(id)
          axios.get('/api/v1.0/kamban/' + id + '/')
            .then(response => {
              //this.Project_list = response.data
              //console.log(response.data)
              self.subitemKamban = response.data
            })
            .catch(error => { console.log(error) })

        },
        //Funcion para apartado de tabla
        async List_Coment(id) {
          var self = this;
          self.drawerEdit = true
          self.List_Comment_drawer = []
          //Listado de Comentarios por Task
          let List_Comentarios = await axios.get('/api/v1.0/comment/?search=' + id)
          //self.List_Comment_drawer = List_Comentarios.data
          //console.log(List_Comentarios.data)
          self.extraImage(List_Comentarios.data)
          /*let ids = 0
          for(i in List_Comentarios){
            ids = List_Comentarios.data[i].owner.id
            let Profile_Image = await axios.get('/api/v1.0/profile/?search='+ ids)
            console.log(Profile_Image.data)
          }*/
          //Extraer detalles de la Tarea
          let Detail_Task = await axios.get('/api/v1.0/task/' + id + '/')
          self.List_Task_drawer = Detail_Task.data
          //console.log(self.List_Task_drawer)

          //Guadamos temporal el id para agragar a futuro nuevos comentarios
          self.id_task = id
        },
        //Informacion de barra lateral izquieda, muestra comentarios, participantes, form de modificacion de estatus 
        //y mas detalles de la misma tarea
        async extraImage(data) {
          var self = this;
          for (i in data) {
            let Profile_Image = await axios.get('/api/v1.0/profile/?search=' + data[i].owner.id)
            console.log(data[i])
            console.log(Profile_Image.data[0])
            if (Profile_Image.data[0] != undefined) {
              self.List_Comment_drawer.push({ 'id': data[i].id, 'owner': data[i].owner, 'image': Profile_Image.data[0].image, 'comment': data[i].comment, 'date_create': data[i].date_create, 'date_time_c': data[i].date_time_c })
            }
            else {
              self.List_Comment_drawer.push({ 'id': data[i].id, 'owner': data[i].owner, 'image': 'https://k60.kn3.net/89F951249.gif', 'comment': data[i].comment, 'date_create': data[i].date_create, 'date_time_c': data[i].date_time_c })
            }
          }
        },

        //AGREGAR COMENTARIO A TASK POR MEDIO DEL ID DE TASK
        Task_add_comment() {
          var self = this;
          //console.log(self.id_task)

          axios.post('/api/v1.0/commentAdd/', {
            comment: self.id_task_comentario,
            owner: ID_Token,
            task: self.id_task,
          }, {
            headers: { 'X-CSRFTOKEN': CSRF_TOKEN, },
          })
            .then(function (response) {
              //console.log(response);
              self.List_Coment(self.id_task)
              self.id_task_comentario = ""
              self.notification('New comment', 'Action added successfully')
            })
            .catch(function (error) {
              console.log(error);
            });
        },

        async Task_Mark_Finished() {
          var self = this;
          //console.log(self.id_task)

          axios.put('/api/v1.0/task/' + self.id_task + '/', {
            id: self.id_task,
            status: false,
            owner: ID_Token,
            title: self.List_Task_drawer.title,
            project: self.List_Task_drawer.project,


          }, {
            headers: { 'X-CSRFTOKEN': CSRF_TOKEN, },
          })
            .then(function (response) {
              console.log(response);

            })
            .catch(function (error) {
              console.log(error);
            });

        },

        //NOTIFICACIONES PUSH
        notification(titulo, comentario) {
          var self = this;

          self.snackbar_titulo = titulo
          self.snackbar_comentario = comentario
          self.snackbar = true

        },



        ///CREACION DE PROYECTOS
        //Funcion traera desde la el create project todos los Kamban y sus respectivas task 
        List_Kamban_Task_Project_Select(data) {
          //Extraer Kamban del proyecto seleccionado
          console.log("Ejecutando")
          if(data.length > 0 ){
          
          axios.get('/api/v1.0/project/' + data[0].id + '/')
            .then(response => {
              this.kambaProjectCreate = response.data
              console.log(response.data)
              //self.itemsKamban = response.data
            })
            .catch(error => { console.log(error) })
          }

        },






        ///CREACION DE PROYECTOS

      },
    });


  </script>
</body>

</html>